# Internal Code Documentation: Distutils Management

[Linked Table of Contents](#linked-table-of-contents)

## Linked Table of Contents

* [1. Overview](#1-overview)
* [2. `warn_distutils_present()` Function](#2-warn_distutils_present-function)
* [3. `clear_distutils()` Function](#3-clear_distutils-function)
* [4. `enabled()` Function](#4-enabled-function)
* [5. `ensure_local_distutils()` Function](#5-ensure_local_distutils-function)
* [6. `do_override()` Function](#6-do_override-function)
* [7. `_TrivialRe` Class](#7-_trivialre-class)
* [8. `DistutilsMetaFinder` Class](#8-distutilsmetafinder-class)
    * [8.1 `find_spec()` Method](#81-find_spec-method)
    * [8.2 `spec_for_distutils()` Method](#82-spec_for_distutils-method)
    * [8.3 `is_cpython()` Method](#83-is_cpython-method)
    * [8.4 `spec_for_pip()` Method](#84-spec_for_pip-method)
    * [8.5 `pip_imported_during_build()` Method](#85-pip_imported_during_build-method)
    * [8.6 `frame_file_is_setup()` Method](#86-frame_file_is_setup-method)
    * [8.7 `spec_for_sensitive_tests()` Method](#87-spec_for_sensitive_tests-method)
* [9. `add_shim()` Function](#9-add_shim-function)
* [10. `shim` Class](#10-shim-class)
* [11. `insert_shim()` Function](#11-insert_shim-function)
* [12. `_remove_shim()` Function](#12-_remove_shim-function)


## 1. Overview

This module manages the interaction between `setuptools` and the standard library's `distutils` module.  It aims to prioritize a local, `setuptools`-provided version of `distutils` while gracefully handling potential conflicts and edge cases.  The core functionality revolves around the `DistutilsMetaFinder` class, which acts as an import hook to intercept and control the loading of `distutils`.

## 2. `warn_distutils_present()` Function

This function issues a warning if `distutils` has already been imported before `setuptools`.  It checks for exceptions for PyPy versions before 3.7, which unconditionally imports `distutils`.

| Condition | Action |
|---|---|
| `'distutils'` not in `sys.modules` | Returns without action. |
| PyPy and Python version < 3.7 | Returns without action (PyPy's behavior is bypassed). |
| Otherwise | Issues a warning about potential conflicts. |


## 3. `clear_distutils()` Function

This function removes `distutils` and its submodules from `sys.modules`.  It's used to ensure a clean slate before loading the `setuptools` version.

| Condition | Action |
|---|---|
| `'distutils'` not in `sys.modules` | Returns without action. |
| Otherwise | Issues a warning and removes `distutils` related modules from `sys.modules`. |


## 4. `enabled()` Function

This function determines whether the local `distutils` should be used based on the environment variable `SETUPTOOLS_USE_DISTUTILS`.

| `SETUPTOOLS_USE_DISTUTILS` Value | Return Value |
|---|---|
| `'local'` (or unset) | `True` |
| Any other value | `False` |


## 5. `ensure_local_distutils()` Function

This function clears the existing `distutils` from `sys.modules` and then imports the `setuptools` version using a shim.  It then performs assertions to verify that the correct version has been loaded and submodules are accessible.  This uses the `shim` context manager to temporarily modify the `sys.meta_path`

## 6. `do_override()` Function

This function serves as the main entry point for overriding the standard library `distutils`.  It checks if the local `distutils` is enabled and then calls `warn_distutils_present()` and `ensure_local_distutils()`.


## 7. `_TrivialRe` Class

A simple regular expression-like class that checks if all provided patterns are present in a given string.  It's used internally for simple pattern matching and avoids the overhead of importing the `re` module.


## 8. `DistutilsMetaFinder` Class

This class is the core of the distutils management. It implements the `importlib.meta_path` protocol, intercepting import requests for `distutils` and related modules.

### 8.1 `find_spec()` Method

This method is the entry point for the `meta_path` protocol. It uses a dynamic dispatch to call a specific method based on the imported module name for optimization.

### 8.2 `spec_for_distutils()` Method

This method handles import requests specifically for the `distutils` module. If running under CPython, it returns `None`, deferring to the standard library's distutils. Otherwise, it attempts to import `setuptools._distutils` and creates a custom `Loader` to return the local distutils module. If `setuptools._distutils` is unavailable, it falls back to default behavior.

### 8.3 `is_cpython()` Method

This static method checks if the code is running within the CPython build or test environment, using the presence of `pybuilddir.txt` as an indicator.  Returns `True` if within CPython build/test, otherwise `False`.

### 8.4 `spec_for_pip()` Method

This method handles import requests during pip installation to ensure that the standard library's `distutils` is used instead of the `setuptools` version, resolving potential issues with pip.  It clears existing `distutils` instances and disables future use of the override.  It accounts for Python 3.12+ behavior changes.

### 8.5 `pip_imported_during_build()` Method

This class method checks the call stack to determine if pip is being imported within a setup.py file (common in build scripts). It uses `traceback.walk_stack()` for this analysis.

### 8.6 `frame_file_is_setup()` Method

This static method checks if a given stack frame indicates a `setup.py` file.  Handles potential absence of `__file__` attribute in some frames.

### 8.7 `spec_for_sensitive_tests()` Method

This method handles import requests for specific CPython tests that are known to be sensitive to the distutils implementation. It clears the `distutils` and disables the override to use the standard library's version.  The tests covered change slightly based on Python version.


## 9. `add_shim()` Function

This function adds the `DistutilsMetaFinder` to `sys.meta_path` if it's not already present.

## 10. `shim` Class

This class provides a context manager (`with` statement) to temporarily add and remove the `DistutilsMetaFinder` from `sys.meta_path`.

## 11. `insert_shim()` Function

This function adds the `DistutilsMetaFinder` to the beginning of `sys.meta_path`.

## 12. `_remove_shim()` Function

This function removes the `DistutilsMetaFinder` from `sys.meta_path`, handling potential `ValueError` exceptions if it's not found.
